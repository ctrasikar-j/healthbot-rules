/*
 *   This rule collects l2circuit statistics and notifies anomaly when
 *   connection state is down.
 *
 *
 */
 healthbot {
    topic vpn.l2circuit {
        rule check-l2circuit-pw-state {
            keys [ neighbor cnx-id ];
            sensor l2ckt {
                iAgent {
                    file L2CircuitConnectionInfo.yml;
                    table L2CircuitConnectionInfoTable;
                    frequency 180s;
                }
            }
            field cnx-id {
                sensor l2ckt {
                    where "connection-id =~ /{{connection-id}}/";
                    path connection-id;
                }
                type string;
                description "l2circuit connection ID";
            }
            field neighbor {
                sensor l2ckt {
                    where "neighbor-address =~ /{{neighbor-address}}/";
                    path neighbor-address;
                }
                type string;
                description "l2circuit neighbor address";
            }
            field connection-status {
                sensor l2ckt {
                    path connection-status;
                }
                type string;
                description "l2circuit connection status";
                enumerate EI as -13;
                enumerate MM as -12;
                enumerate EM as -11;
                enumerate CM as -10;
                enumerate VM as -9;
                enumerate OL as -8;
                enumerate NC as -7;
                enumerate BK as -6;
                enumerate CB as -5;
                enumerate LD as -4;
                enumerate RD as -3;
                enumerate NP as -2;
                enumerate Dn as 0;
                enumerate VC-Dn as -1;
                enumerate UP as 1;
                enumerate CF as -14;
                enumerate IB as -15;
                enumerate TDM as -16;
                enumerate ST as -17;
                enumerate SP as -18;
                enumerate RS as -19;
                enumerate XX as -20;
            }
            trigger l2circuit-connection-status {
                frequency 1offset;
                term is-l2ckt-connection-up {
                    when {
                        matches-with "$connection-status" Up {
                            ignore-case;
                        }
                    }
                    then {
                        status {
                            color green;
                            message "l2circuit neighbor-address:$neighbor connection-id:$cnx-id state is $connection-status";
                        }
                    }
                }
                term l2ckt-connection-down {
                    then {
                        status {
                            color red;
                            message "l2circuit neighbor-address:$neighbor connection-id:$cnx-id state is $connection-status";
                        }
                    }
                }
            }
            variable neighbor-address {
                value .*;
                description "Input l2circuit neighbor-address to be monitored in regex.";
                type string;
            }
            variable connection-id {
                value .*;
                description "Input l2circuit connection-id to be monitored in regex.";
                type string;
            }
            rule-properties {
                version 1;
                contributor juniper;
                supported-healthbot-version 4.3.0;
                supported-devices {
                    sensors l2ckt;
                    juniper {
                        operating-system junos {
                            sensors l2ckt;
                            products MX {
                                sensors l2ckt;
                                platforms MX304 {
                                    releases 22.2 {
                                        sensors l2ckt;
                                        release-support min-supported-release;
                                    }
                                }
                                platforms MX204 {
                                    releases 22.2 {
                                        sensors l2ckt;
                                        release-support min-supported-release;
                                    }
                                }
                                platforms MX240 {
                                    releases 22.3R1 {
                                        sensors l2ckt;
                                        release-support min-supported-release;
                                    }
                                }
                                platforms MX480 {
                                    releases 22.3R1 {
                                        sensors l2ckt;
                                        release-support min-supported-release;
                                    }
                                }
                                platforms MX960 {
                                    releases 22.3R1 {
                                        sensors l2ckt;
                                        release-support min-supported-release;
                                    }
                                }
                                platforms MX10004 {
                                    releases 22.3R1 {
                                        sensors l2ckt;
                                        release-support min-supported-release;
                                    }
                                }
                                platforms MX10008 {
                                    releases 22.3R1 {
                                        sensors l2ckt;
                                        release-support min-supported-release;
                                    }
                                }
                                platforms MX10016 {
                                    releases 22.3R1 {
                                        sensors l2ckt;
                                        release-support min-supported-release;
                                    }
                                }
                            }
                        }
                        operating-system junosEvolved {
                            products ACX {
                                sensors l2ckt;
                                platforms ACX7024 {
                                    releases 22.3R1 {
                                        sensors l2ckt;
                                        release-support min-supported-release;
                                    }
                                }
                                platforms ACX7100 {
                                    releases 22.3R1 {
                                        sensors l2ckt;
                                        release-support min-supported-release;
                                    }
                                }
                                platforms ACX7348 {
                                    releases 22.3R1 {
                                        sensors l2ckt;
                                        release-support min-supported-release;
                                    }
                                }
                                platforms ACX7024X {
                                    releases 22.3R1 {
                                        sensors l2ckt;
                                        release-support min-supported-release;
                                    }
                                }
                                platforms ACX7509 {
                                    releases 22.3R1 {
                                        sensors l2ckt;
                                        release-support min-supported-release;
                                    }
                                }
                            }
                            products PTX {
                                sensors l2ckt;
                                platforms PTX10008 {
                                    releases 22.2R3 {
                                        sensors l2ckt;
                                        release-support min-supported-release;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
